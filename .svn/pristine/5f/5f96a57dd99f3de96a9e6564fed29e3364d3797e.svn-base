<?php

namespace Addons\JiDian\Controller;
use Home\Controller\AddonsController;

class JiDianController extends AddonsController{
    //登录vpn获取验证码并且保存cookie设置标记
    //登录vpn获取验证码并且保存cookie设置标记
    public function verify(){
        set_time_limit(0);
    
        //获取TWFID的cookie值
        $snoopy = new SnoopyController();
        $snoopy->agent="Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 10.0; WOW64; Trident/7.0; Touch)";
        $snoopy->cookies["ENABLE_RANDCODE"] = ' 0';
        $snoopy->fetch('https://vpn.hpu.edu.cn/por/login_psw.csp'); //获取所有内容

        $cookies1=$snoopy->headers;
        preg_match('/Set-Cookie:(.*);/iU',$cookies1[4],$cookies1); //正则匹配  
        //print_r($cookies1);
        $arr1=explode('=', $cookies1[1]);
        $cookie1=$arr1[1];


        //获取websvr_cookie的cookie值
        $snoopy = new SnoopyController();
        $snoopy->referer='https://vpn.hpu.edu.cn/por/login_psw.csp';//例如：http://www.baidu.com/

        $snoopy->agent="Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 10.0; WOW64; Trident/7.0; Touch)";

        $arr=array(); 
        $arr[0][]="311303030206";
        $arr[0][]="296111";
        $arr[1][]="311307000921";
        $arr[1][]="023018";
        $arr[2][]="311403030230";
        $arr[2][]="244536";
        $arr[3][]="311504000923";
        $arr[3][]="193519";
        $arr[4][]="311503040222";
        $arr[4][]="156396";
        $arr[5][]="311503040103";
        $arr[5][]="169629";
        $arr[6][]="311514020129";
        $arr[6][]="296020";
        $ran=rand(0,6);

        $post['mitm_result']="";
        $post['svpn_name']=$arr[$ran][0];
        $post['svpn_password']=$arr[$ran][1];
        $post['svpn_rand_code']="";

        $url='https://vpn.hpu.edu.cn/por/login_psw.csp?sfrnd=2346912324982305';//登陆数据提交的URL地址
        $snoopy->cookies["ENABLE_RANDCODE"] = ' 0';
        $snoopy->cookies["TWFID"] = $cookie1;
        $snoopy->submit($url,$post);

        $snoopy->fetch("https://vpn.hpu.edu.cn/web/1/http/1/218.196.240.97");//希望获取的页面数据
        $snoopy->cookies["ENABLE_RANDCODE"] = ' 0';
        $snoopy->cookies["TWFID"] = $cookie1;
        $cookies2=$snoopy->headers;
        preg_match('/Set-Cookie:(.*);/iU',$cookies2[5],$cookies2); //正则匹配  
        $arr2=explode('=', $cookies2[1]);
        $cookie2=$arr2[1];

        //获取验证码
        $snoopy->referer='https://vpn.hpu.edu.cn/por/login_psw.csp';

        $snoopy->agent="Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 10.0; WOW64; Trident/7.0; Touch)";

        $snoopy->cookies["ENABLE_RANDCODE"] = ' 0';
        $snoopy->cookies["TWFID"] = $cookie1;
        $snoopy->cookies["websvr_cookie"] = $cookie2;
        setcookie('isl','1');
        setcookie("TWFID",$cookie1);
        setcookie("ENABLE_RANDCODE",' 0');
        setcookie("websvr_cookie",$cookie2);
        //print_r($_COOKIE);

        $snoopy->fetch("https://vpn.hpu.edu.cn/web/0/http/1/218.196.240.97/validateCodeAction.do");

        echo $snoopy->results;

    }


    //登录页面
    public function login(){ 
        $snoopy = new SnoopyController();
        $snoopy->agent="Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 10.0; WOW64; Trident/7.0; Touch)";
        $snoopy->cookies["nllr_2132_widthauto"] = '-1';
        $snoopy->cookies["nllr_2132_saltkey"] = 'G3k9DAaA';
        $snoopy->cookies["nllr_2132_lastvisit"] = '1460461548';
        $snoopy->cookies["nllr_2132_auth"] = '8066olXkUGruLW4dk797Zy50ShbdsogXkrPAx81i%2F0kkXJKcJia%2BrZUfKLKFcC6c%2BDZPGutGk%2BtQRICzHOtB';
        $snoopy->cookies["nllr_2132_lastcheckfeed"] = '1%7C1460465156';
        $snoopy->cookies["nllr_2132_editormode_e"] = '1';
        $snoopy->cookies["nllr_2132_nofavfid"] = '1';
        $snoopy->cookies["nllr_2132_visitedfid"] = '39D2D36';
        $snoopy->cookies["nllr_2132_smile"] = '1D1';
        $snoopy->cookies["nllr_2132_ulastactivity"] = 'f642MgN%2FDDQNQ35o9I1jN%2B4nMIWe7neO5%2BmuGfepgOHsX9VNGGHa';

        $user=M('user');
        $openid=$_GET['openid'];
        $studentid = $user->where("openid=".'"'.$openid.'"')->getField('studentid');
        $password = $user->where("openid=".'"'.$openid.'"')->getField('password');
        $this->assign('studentid',$studentid);
        $this->assign('password',$password);
        $this->display();
    }

    public function jidian(){  
        if(isset($_COOKIE['isl'])){
            $cookie1=$_COOKIE['websvr_cookie'];
            $cookie2=$_COOKIE['ENABLE_RANDCODE'];
            $cookie3=$_COOKIE['TWFID'];
        }
        $snoopy=new SnoopyController();

        $snoopy->referer='https://vpn.hpu.edu.cn/web/1/http/1/218.196.240.97';

        $snoopy->agent="Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 10.0; WOW64; Trident/7.0; Touch)";

        $post['zjh']=$_POST['zjh'];
        $post['mm']=$_POST['mm'];
        $post['v_yzm']=$_POST['v_yzm'];

        $snoopy->cookies["websvr_cookie"] = $_COOKIE['websvr_cookie'];
        $snoopy->cookies["ENABLE_RANDCODE"] = $_COOKIE['ENABLE_RANDCODE'];
        $snoopy->cookies["TWFID"] = $_COOKIE['TWFID'];

        $url='https://vpn.hpu.edu.cn/web/1/http/1/218.196.240.97/loginAction.do';//登陆数据提交的URL地址

        $snoopy->submit($url,$post);

        $snoopy->fetch("https://vpn.hpu.edu.cn/web/1/http/2/218.196.240.97/gradeLnAllAction.do?type=ln&oper=sxinfo&lnsxdm=001#qb_001");//希望获取的页面数据
        //print_r($_COOKIE);
        $content = $snoopy->results;//输出结果，登陆成功

        //对页面进行排序
        $content=iconv("gbk", "utf-8", $content);
        curl_close ( $ch );

        $html=new SimpleHtmlController();
        $html->load($content);
        //必修
        $table=$html->find('table')[5];
        $arr1=$this->get_td_array($table);//执行函数
        //选修
        @$table=$html->find('table')[13];
        if($table){
            $arr2=$this->get_td_array($table);//执行函数
        }else{
            $arr2=array();
        }
        //任选
        @$table=$html->find('table')[22];
        if($table){
            $arr3=$this->get_td_array($table);//执行函数
        }else{
            $arr3=array();
        }
        $arr=array_merge($arr1,$arr2,$arr3);
        //print_r($arr);
        $str=json_encode($arr,JSON_UNESCAPED_UNICODE);
        //echo $str;
        $str=str_replace("中等", "75.0",$str);
        $str=str_replace("良好", "85.0",$str);
        $str=str_replace("优秀", "95.0",$str);
        $str=str_replace("及格", "60.0",$str);
        $arr=json_decode($str);
        //$arr=unserialize(preg_replace('!s:(\d+):"(.*?)";!se', "'s:'.strlen('$2').':\"$2\";'",  $str));
        //print_r($arr);
        $data1=array();
        $data2=array();
        $data3=array();
        foreach($arr as $k=>$v){
            if(count($v)>6){
                //上海交大4.3
                if($v[6]>=95&&$v[6]<=100){
                    $data1[0][]=$v[4]*4.3;
                }else if($v[6]>=90&&$v[6]<=94){
                    $data1[1][]=$v[4]*4.0;
                }else if($v[6]>=85&&$v[6]<=89){
                    $data1[2][]=$v[4]*3.7;
                }else if($v[6]>=80&&$v[6]<=84){
                    $data1[3][]=$v[4]*3.3;
                }else if($v[6]>=75&&$v[6]<=79){
                    $data1[4][]=$v[4]*3.0;
                }else if($v[6]>=70&&$v[6]<=74){
                    $data1[5][]=$v[4]*2.7;
                }else if($v[6]>=67&&$v[6]<=69){
                    $data1[6][]=$v[4]*2.3;
                }else if($v[6]>=65&&$v[6]<=66){
                    $data1[7][]=$v[4]*2.0; 
                }else if($v[6]>=62&&$v[6]<=64){
                    $data1[9][]=$v[4]*1.7;
                }else if($v[6]>=60&&$v[6]<=61){
                    $data1[10][]=$v[4]*1.0;
                }else if($v<60){
                    $data1[11][]=$v[4]*0;
                }
                //标准绩点计算
                if($v[6]>=90&&$v[6]<=100){
                    $data2[1][]=$v[4]*4.0;
                }else if($v[6]>=85&&$v[6]<=89){
                    $data2[2][]=$v[4]*3.7;
                }else if($v[6]>=82&&$v[6]<=84){
                    $data2[3][]=$v[4]*3.3;
                }else if($v[6]>=78&&$v[6]<=81){
                    $data2[4][]=$v[4]*3.0;
                }else if($v[6]>=75&&$v[6]<=77){
                    $data2[5][]=$v[4]*2.7;
                }else if($v[6]>=72&&$v[6]<=74){
                    $data2[6][]=$v[4]*2.3;
                }else if($v[6]>=68&&$v[6]<=71){
                    $data2[7][]=$v[4]*2.0; 
                }else if($v[6]>=64&&$v[6]<=67){
                    $data2[8][]=$v[4]*1.5;
                }else if($v[6]>=60&&$v[6]<=63){
                    $data2[9][]=$v[4]*1.0;
                }else if($v<60){
                    $data2[10][]=$v[4]*0;
                }
                //中科大4.3
                if($v[6]>=95&&$v[6]<=100){
                    $data3[0][]=$v[4]*4.3;
                }else if($v[6]>=90&&$v[6]<=94){
                    $data3[1][]=$v[4]*4.0;
                }else if($v[6]>=85&&$v[6]<=89){
                    $data3[2][]=$v[4]*3.7;
                }else if($v[6]>=82&&$v[6]<=84){
                    $data3[3][]=$v[4]*3.3;
                }else if($v[6]>=78&&$v[6]<=81){
                    $data3[4][]=$v[4]*3.0;
                }else if($v[6]>=75&&$v[6]<=77){
                    $data3[5][]=$v[4]*2.7;
                }else if($v[6]>=72&&$v[6]<=74){
                    $data3[6][]=$v[4]*2.3;
                }else if($v[6]>=68&&$v[6]<=71){
                    $data3[7][]=$v[4]*2.0; 
                }else if($v[6]>=65&&$v[6]<=67){
                    $data3[8][]=$v[4]*1.7;
                }else if($v[6]>=62&&$v[6]<=64){
                    $data3[9][]=$v[4]*1.5;
                }else if($v[6]>=61&&$v[6]<=63){
                    $data3[10][]=$v[4]*1.3;
                }else if($v[6]==60){
                    $data3[11][]=$v[4]*1.0;
                }else if($v<60){
                    $data3[12][]=$v[4]*0;
                }
                $data['fen'][]=$v[4];
            }
        }
        //print_r($arr[count($data['fen'])+1]);
        $h1=array();
        $h2=array();
        $h3=array();
        foreach($data1 as $v){
            $h1[]=array_sum($v)."<br>";
        }
        foreach($data2 as $v){
            $h2[]=array_sum($v)."<br>";
        }
        foreach($data3 as $v){
            $h3[]=array_sum($v)."<br>";
        }
        $fen=array_sum($data['fen']);
        
        $user=M('user');
        $openid=$_GET['openid'];
        $name = $user->where("openid=".'"'.$openid.'"')->getField('name');
        
        
        $fen=array_sum($data['fen']);
        $con=count($data['fen']);
        $this->assign('name',$name);
        $this->assign('con',$con);
        $this->assign("fen",$fen);
        $this->assign("h1",$h1);
        $this->assign("h2",$h2);
        $this->assign("h3",$h3);
        $this->display();
    }
    
    
    function get_td_array($table) { 
        $table = preg_replace("'<table[^>]*?>'si","",$table); 
        $table = preg_replace("'<tr[^>]*?>'si","",$table); 
        $table = preg_replace("'<td[^>]*?>'si","",$table); 
        $table = str_replace("</tr>","{tr}",$table); 
        //PHP开源代码
        $table = str_replace("</td>","{td}",$table); 
        //去掉 HTML 标记  
        $table = preg_replace("'<[/!]*?[^<>]*?>'si","",$table); 
        //去掉空白字符   
        $table = preg_replace("'([rn])[s]+'","",$table); 
        $table = str_replace(" ","",$table); 
        $table = str_replace("&nbsp;","",$table); 
        $table = str_replace(" ","",$table);
        $table = explode('{tr}', $table); 
        array_pop($table);  
        foreach ($table as $key=>$tr) { 
            $td = explode('{td}', $tr); 
            array_pop($td); 
            $td_array[] = $td; 
        } 
        return $td_array; 
    }
}
