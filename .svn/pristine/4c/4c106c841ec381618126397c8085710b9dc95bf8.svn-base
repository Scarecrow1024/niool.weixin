<?php
/* *
 * 作者：张彦飞
 * niool.com
 * 版本：1.2
 * 日期：2016-01-22
 */

namespace Addons\SchoolCard\Model;

use Home\Model\WeixinModel;

/**
 * SchoolCard的微信模型
 */
class WeixinAddonModel extends WeixinModel {
	function reply() {
                $openid=get_openid();
                $user=M('user');
                $studentid=$user->where("openid=".'"'.$openid.'"')->getField('studentid');
                if($studentid==0){
                        $this->subscribe();
                        $openid=get_openid();
                        $url=addons_url ('Binding://Binding/login?openid='.$openid);
                        $dataArr[0]=array(
                                'Title' => '绑定',
                                'Description' => '点击图片完成账号绑定',
                                'PicUrl' => 'http://www.pp3.cn/uploads/allimg/120129/1-120129232444.jpg',
                                'Url' => $url
                            );
                        $dataArr[1]=array(
                                'Title' => '你还未绑定账号点击图片完成认证',                   
                            );
                                $this->replyNews($dataArr);
                }else{
                        $rs=curl_init();
                        $user=M('user');
                        $openid=get_openid();
                        $data = $user->where("openid=".'"'.$openid.'"')->find();
                        $idcard=$data['IdCard'];
                        $studentid=$data['studentid'];
                        $idcard=substr($idcard, 11, 6);
                        $url="http://my.hpu.edu.cn/userPasswordValidate.portal";
                        $post="Login.Token1=".$studentid."&Login.Token2=".$idcard."&goto=http%3A%2F%2Fmy.hpu.edu.cn%2FloginSuccess.portal&gotoOnFail=http%3A%2F%2Fmy.hpu.edu.cn%2FloginFailure.portal"; 
                        curl_setopt($rs,CURLOPT_URL,$url);
                        curl_setopt($rs,CURLOPT_REFERER,"http://my.hpu.edu.cn/login.portal");
                        curl_setopt($rs,CURLOPT_POST,1);
                        curl_setopt($rs,CURLOPT_POSTFIELDS,$post);
                        curl_setopt($rs,CURLOPT_COOKIESESSION,1);
                        curl_setopt($rs,CURLOPT_COOKIEFILE,"cookie");
                        curl_setopt($rs,CURLOPT_COOKIEJAR, "cookie");
                        curl_setopt($rs,CURLOPT_COOKIE,session_name().'='.session_id());
                        curl_setopt($rs,CURLOPT_RETURNTRANSFER,1);
                        curl_setopt($rs,CURLOPT_FOLLOWLOCATION,1);
                        curl_exec($rs);
                        curl_setopt($rs,CURLOPT_URL,"http://my.hpu.edu.cn/pnull.portal?.p=Znxjb20ud2lzY29tLnBvcnRhbC5zaXRlLnYyLmltcGwuRnJhZ21lbnRXaW5kb3d8ZjEyMDd8dmlld3xub3JtYWx8&.nctp=true&.ll=true&.reqId=454292a2-805e-11e5-8ee7-93b0a51465ca&.isTW=false");
                        curl_setopt($rs,CURLOPT_REFERER,"http://my.hpu.edu.cn/index.portal");
                        curl_setopt($rs,CURLOPT_RETURNTRANSFER,1);
                        $content=curl_exec($rs);
                        curl_close($rs);
                        $content=strip_tags($content)."<br>";
                        preg_match_all("/[0-9]+/", $content, $matches);
                        //print_r($matches);
                        $str="你的饭卡余额为￥".$matches[0][4].".".$matches[0][5]."元"."\n温馨提示:你有".$matches[0][1]."项赛课作业";

                        $this->replyText($str);
                }
        
	}
	
	// 关注公众号事件
	public function subscribe() {
		$user=M('user');
                $openid=get_openid();
                $data['openid']=$openid;
                $data['subscribe_time']=date("Y-m-d H:i",time());
                $is=$user->where("openid=".'"'.$openid.'"')->find();
                if(!$is){
                    $user->add($data);
                }      
                return true;
	}
	
	// 取消关注公众号事件
	public function unsubscribe() {
		return true;
	}
	
	// 扫描带参数二维码事件
	public function scan() {
		return true;
	}
	
	// 上报地理位置事件
	public function location() {
		return true;
	}
	
	// 自定义菜单事件
	public function click() {
		return true;
	}
}
        	