<?php
/* *
 * 作者：张彦飞
 * niool.com
 * 版本：1.2
 * 日期：2016-03-20
 */

namespace Addons\BxqScore\Controller;
use Home\Controller\AddonsController;

class BxqScoreController extends AddonsController{
    public function verify(){
        set_time_limit(0);
    
        $niool = new NioolController();
        $niool->cookies["ENABLE_RANDCODE"] = ' 0';
        $niool->fetch('https://vpn.hpu.edu.cn/por/login_psw.csp'); //获取所有内容

        $cookies1=$niool->headers;
        preg_match('/Set-Cookie:(.*);/iU',$cookies1[4],$cookies1); 

        $arr1=explode('=', $cookies1[1]);
        $cookie1=$arr1[1];

        $niool = new NioolController();
        $niool->referer='https://vpn.hpu.edu.cn/por/login_psw.csp';

        $niool->agent="Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 10.0; WOW64; Trident/7.0; Touch; .NET4.0C; .NET4.0E; Tablet PC 2.0)";

        $post['mitm_result']="";
        $post['svpn_name']='311503040222';
        $post['svpn_password']='156396';
        $post['svpn_rand_code']="";
        $url='https://vpn.hpu.edu.cn/por/login_psw.csp?sfrnd=2346912324982305';
        $niool->cookies["ENABLE_RANDCODE"] = ' 0';
        $niool->cookies["TWFID"] = $cookie1;
        $niool->submit($url,$post);

        $niool->fetch("https://vpn.hpu.edu.cn/web/1/http/1/218.196.240.97");
        $niool->cookies["ENABLE_RANDCODE"] = ' 0';
        $niool->cookies["TWFID"] = $cookie1;
        $cookies2=$niool->headers;
        preg_match('/Set-Cookie:(.*);/iU',$cookies2[5],$cookies2); 
        $arr2=explode('=', $cookies2[1]);
        $cookie2=$arr2[1];

        $niool->referer='https://vpn.hpu.edu.cn/por/login_psw.csp';

        $niool->agent="Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 10.0; WOW64; Trident/7.0; Touch; .NET4.0C; .NET4.0E; Tablet PC 2.0)";

        $niool->cookies["ENABLE_RANDCODE"] = ' 0';
        $niool->cookies["TWFID"] = $cookie1;
        $niool->cookies["websvr_cookie"] = $cookie2;
        setcookie('isl','1');
        setcookie("TWFID",$cookie1);
        setcookie("ENABLE_RANDCODE",' 0');
        setcookie("websvr_cookie",$cookie2);

        $niool->fetch("https://vpn.hpu.edu.cn/web/0/http/1/218.196.240.97/validateCodeAction.do");

        echo $niool->results;

    }

    public function login(){ 
        $this->display();
    }

    function index(){
        $niool=new NioolController();

        $niool->referer='https://vpn.hpu.edu.cn/web/1/http/1/218.196.240.97';

        $niool->agent="Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 10.0; WOW64; Trident/7.0; Touch; .NET4.0C; .NET4.0E; Tablet PC 2.0)";

        $post['zjh']=$_POST['zjh'];
        $post['mm']=$_POST['mm'];
        $post['v_yzm']=$_POST['v_yzm'];

        $niool->cookies["websvr_cookie"] = $_COOKIE['websvr_cookie'];
        $niool->cookies["ENABLE_RANDCODE"] = $_COOKIE['ENABLE_RANDCODE'];
        $niool->cookies["TWFID"] = $_COOKIE['TWFID'];

        $url='https://vpn.hpu.edu.cn/web/1/http/1/218.196.240.97/loginAction.do';

        $niool->submit($url,$post);

        $niool->fetch("https://vpn.hpu.edu.cn/web/1/http/2/218.196.240.97/bxqcjcxAction.do");
        //print_r($_COOKIE);
        $content = $niool->results;
        $content = iconv("gbk", "utf-8", $content);
        //echo $content;
        $html=new SimpleHtmlController();
        $html->load($content);
        $table=$html->find('table')[5];
        $arr=$this->get_td_array($table);
        $data=array();
        foreach($arr as $k=>$v){
            if(count($v)>2){
                $data['kcm'][]=$v[2];
                $data['xf'][]=$v[4];
                $data['kcsx'][]=$v[5];
                $data['zgf'][]=$v[6];
                $data['zdf'][]=$v[7];
                $data['pjf'][]=$v[8];
                $data['cj'][]=$v[9];
                $data['mc'][]=$v[10];
            } 
        }
        $con=count($data['kcm']);
        $this->assign('data',$data);
        $this->assign('con',$con);
        $this->display();
    }

    
    public function get_td_array($table) { 
        $table = preg_replace("'<table[^>]*?>'si","",$table); 
        $table = preg_replace("'<tr[^>]*?>'si","",$table); 
        $table = preg_replace("'<td[^>]*?>'si","",$table); 
        $table = str_replace("</tr>","{tr}",$table); 
        $table = str_replace("</td>","{td}",$table); 
        $table = preg_replace("'<[/!]*?[^<>]*?>'si","",$table);  
        $table = preg_replace("'([rn])[s]+'","",$table); 
        $table = str_replace(" ","",$table); 
        $table = str_replace("&nbsp;","",$table); 
        $table = str_replace(" ","",$table);
        $table = explode('{tr}', $table); 
        array_pop($table);  
        foreach ($table as $key=>$tr) { 
            $td = explode('{td}', $tr); 
            array_pop($td); 
            $td_array[] = $td; 
        } 
        return $td_array; 
    }
   
}
